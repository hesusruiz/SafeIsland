<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Verifiable Credentials for a Safe Island">
    <meta name="theme-color" content="#2F3BA2" />
    <title>Safe Island</title>

    <!-- Font Awesome Free 5.15.1 -->
    <link rel="stylesheet" href="css/all.css">

    <!-- Customized Bulma 0.9.1 CSS framework -->
    <link rel="stylesheet" href="css/mystyles.css">

    <!-- Specific CSS for this project -->
    <link rel="stylesheet" href="css/safeisland.css">

    <link rel="manifest" href="/manifest.json">

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="SafeIsland">
    <link rel="apple-touch-icon" href="img/icon-152.png">

    <style>
        /* Center the loader */
        #loader {
            position: absolute;
            left: 50%;
            top: 50%;
            z-index: 1;
        }
    </style>

</head>

<body>
<img id="backgroundImage" src= "/static/img/bg-hero.png"/>


<script>
    // Initialize the array of pages in the application
    var pages = {}
</script>

<span id="loader" class="icon">
    <i class="fas fa-spinner fa-spin fa-5x"></i>
</span>


<!-- =========================================== -->
<!-- NAVIGATION BAR -->
<!-- =========================================== -->

<nav id="appNavbar" class="navbar is-transparent" role="navigation" aria-label="main navigation">
    <div class="navbar-brand">
        <a class="navbar-item" href="#homePage">
            <img src="img/Logo.png" width="112" height="35">
        </a>

        <div class="buttons">
            <button class="button is-link" style="display: none;" id="butInstall" aria-label="Install">Install
                locally</button>
        </div>
        
        <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="settingsMenu">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
    </div>

    <div id="settingsMenu" class="navbar-menu">

        <div class="navbar-end">
      
            <div class="navbar-item has-dropdown is-hoverable">
                <a class="navbar-link is-primary">
                    Menu
                </a>
      
                <div class="navbar-dropdown is-right">
                    <a class="navbar-item" href="#settingsHome" onclick="menuClose();">
                        Settings
                    </a>
                    <hr class="navbar-divider">
                    <a class="navbar-item">
                        Help
                    </a>
                </div>
            </div>
        </div>

    </div>

</nav>

<!-- =========================================== -->
<!-- END NAVIGATION BAR -->
<!-- =========================================== -->


<!-- =========================================== -->
<!-- HOME PAGE -->
<!-- =========================================== -->
<div id="homePage" class="jrmpage">
    <script>
        pages["#homePage"] = async function () {
            console.log("=> Inside home")
        }
    </script>

    <div class="section">
        <div class="container">

            <div class="card">
                <div class="card-content">
                    <p class="title">
                        I am a Passenger
                    </p>
                    <p class="subtitle">
                        Receive or show your test results
                    </p>
                
                </div>
                <footer class="card-footer">
                    <p class="card-footer-item">
                        <a class="button is-link is-medium" href="#passengerHome">Go</a>
                    </p>
                </footer>
            </div>

            </br>

            <div class="card">
                <div class="card-content">
                    <p class="title">
                        I am a Controller
                    </p>
                    <p class="subtitle">
                        Review the test results of a passenger
                    </p>
                </div>
                <footer class="card-footer">
                    <p class="card-footer-item">
                        <a class="button is-link is-medium is-fullwidth" href="#verifierScanQR">Go</a>
                    </p>
                </footer>
            </div>

            </br>

            <div class="card">
                <div class="card-content">
                    <p class="title">
                        I am an Issuer
                    </p>
                    <p class="subtitle">
                        Check my lab test results
                    </p>
                </div>
                <footer class="card-footer">
                    <p class="card-footer-item">
                        <a class="button is-link is-medium is-fullwidth" href="#issuerHome">Go</a>
                    </p>
                </footer>
            </div>

        </div>
    </div>

</div><!-- /page -->


<!-- =========================================== -->
<!-- PASSENGER HOME PAGE -->
<!-- =========================================== -->
<div id="passengerHome" class="jrmpage">

    <script>
        pages["#passengerHome"] = async function () {
            console.log("=> Inside #homePassenger")
        }
    </script>

    <div class="bottomhalf">
        <button id="buttonScan" type="button" class="mybigbutton" onclick="location='#passengerQRScan'">
            <h3 class="mytextbig">Receive a credential</h3>
            <p class="mytextnormal">Scan a QR and store the credential</p>
        </button>
        <button id="buttonList" type="button" class="mybigbutton" onclick="location='#passengerCredList'">
            <h3 class="mytextbig">View my credentials</h3>
            <p class="mytextnormal">Review and manage my credentials</p>
        </button>
    </div>

</div><!-- /page -->


<!-- =========================================== -->
<!-- PASSENGER HOME PAGE -->
<!-- =========================================== -->
<div id="passengerHomeOLD" class="jrmpage">

    <script>
        pages["#passengerHomeOld"] = async function () {
            console.log("=> Inside #homePassenger")
        }
    </script>

    <div class="section">
        <div class="container">

            <div class="card">
                <div class="card-content">
                    <p class="title">
                        Receive a new credential
                    </p>
                    <p class="subtitle">
                        Receive a credential from an Issuer via QR
                    </p>
                </div>
                <footer class="card-footer">
                    <p class="card-footer-item">
                        <a class="button is-link is-medium is-fullwidth" href="#passengerQRScan">Go</a>
                    </p>
                </footer>
            </div>

            </br>

            <div class="card">
                <div class="card-content">
                    <p class="title">
                        Display the current credential
                    </p>
                    <p class="subtitle">
                        Display the current credential in my mobile
                    </p>
                </div>
                <footer class="card-footer">
                    <p class="card-footer-item">
                        <a class="button is-link is-medium is-fullwidth" href="#passengerCredList">Go</a>
                    </p>
                </footer>
            </div>

        </div>
    </div>

</div><!-- /page -->




<!-- =========================================== -->
<!-- PASSENGER QR SCANNING PAGE -->
<!-- =========================================== -->
<div id="passengerQRScan" class="jrmpage">
    <script>
        pages["#passengerQRScan"] = async function () {
            console.log("=> Inside #passengerQRScan")
            initiateReceiveQRScanning("passengerQRScan");
        }
    </script>

    <div class="section">
        <div class="container">

            <div class="card">
                <header class="card-header">
                    <p class="card-header-title">
                        Point to QR from Issuer
                    </p>
                </header>
                <div class="card-content">
                    <div class="content">

                        <canvas class="qrcanvas" id="passengerQRScanCanvas" hidden></canvas>
                        </br>
                        <div id="passengerQRScanMessage">Waiting for QR ...</div>

                    </div>
                </div>
                <footer class="card-footer">
                    <div class="card-footer-item is-centered">
                        <div class="buttons are-medium">
                            <a class="button is-link" style="display: none;" id="passengerQRScanDecodeButton"
                                href="#displayReceivedQR">Decode data</a>
                            <a class="button is-danger" onclick="history.back()">Cancel</a>
                        </div>
                    </div>
                </footer>
            </div>
        </div>
    </div>

</div><!-- /page -->



<!-- =========================================== -->
<!-- PASSENGER CREDENTIAL LIST PAGE -->
<!-- =========================================== -->
<div id="passengerCredList" class="jrmpage">
    <script>
        pages["#passengerCredList"] = async function () {
            console.log("=> Inside #passengerCredList")
            await fillPassengerCredList();
        }
    </script>

    <div class="section">
        <div class="content">
            <h2>List of credentials</h2>
        </div>

        <!-- This is a placeholder that will be filled  by the fillPassengerCredList function -->
        <div class="container" id="passenger_cred_list">

        </div>
    </div>

</div><!-- /page -->

<script>
    console.log("Passenger list page init")
</script>

<script>

var currentCredKey = undefined

    // Gets one credential from the local DB, sets it as default and switches to the display page 
    async function displayCredentialFromKey(key) {
        currentPassengerJWT = await dbCredentials.getItem(key);
        passengerCredential = decodeJWT(currentPassengerJWT);
        await dbSettings.setItem("passengerCredential", passengerCredential);
        currentCredKey = key
        window.location = "#displayCredentialPage";

    }

    // Creates one item of the list for presentation
    async function fillOneItem(key, index, array) {
        var theJWT = await dbCredentials.getItem(key);
        var jwt = decodeJWT(theJWT);
        var cred = ""
        var analysisDate = ""
        var displayName = ""
        
        // get the credential schema
        var schema = jwt['body']['vc']['credentialSchema']['id']

        if (schema == "covidTestResult") {
            displayName = "Covid19 certificate"
            cred = jwt['body']['vc']['credentialSubject']['covidTestResult'];
            analysisDate = cred['analysis']['date']
        }

        if (schema == "vaccinationCredential") {
            displayName = "Vaccination certificate"
            cred = jwt['body']['vc']['credentialSubject']['vaccinationCredential'];
            analysisDate = cred['vaccination']['date']
        }

        if (cred == "") {
            console.log("Error: credential not recognized")
            return
        }

        var cred_date = new Date(analysisDate * 1000);

        $("#passenger_cred_list").append(`
        <div class="card">
            <a onclick="displayCredentialFromKey('${key}')">
                <header class="card-header">
                    <p class="card-header-title">
                        Type: ${displayName}
                    </p>
                </header>
                <div class="card-content">
                    <div class="content">
                        <article>
                        <p>${cred_date.toISOString()}</p>
                        <p>${cred['patient']['name']}</p>
                        </article>
                    </div>
                </div>
            </a>
        </div>
        </br>`
        );
    }

    async function fillPassengerCredList() {
        // Fill the DOM of the verifier page with the received HTML
        // First remove all child elements
        $("#passenger_cred_list").empty();

        keys = await dbAllCredentials();
        if (keys == null) {
            $("#passenger_cred_list").text("Currently you do not have credentials.");
            return;
        }
        $("#passenger_cred_list").html("<div>Click on a credential for more details.</div></br>");

        keys.forEach(fillOneItem);
    }


    async function dbAllCredentials() {

        keys = await dbCredentials.keys();
        console.log(keys);

        // Check if there are keys
        if (keys == null || keys.length == 0) {
            return null;
        }

        // Sort the array in reverse order: newest first
        keys.sort().reverse();

        return keys

    }

</script>
<!-- =========================================== -->
<!-- END PASSENGER CREDENTIAL LIST PAGE -->
<!-- =========================================== -->




<!-- =========================================== -->
<!-- GENERIC CREDENTIAL DISPLAY PAGE             -->
<!-- =========================================== -->
<div id="displayCredentialPage" class="jrmpage">
    <script>
        pages["#displayCredentialPage"] = async function () {
            console.log("=> Inside #displayCredentialPage")
            displayCredentialPage("displayCredentialPlaceholder");
        }
    </script>

    <div id="displayCredentialPlaceholder"></div>

    <div class="section">
        <div class="container">
            <div class="buttons are-medium">
                <a class="button is-link" href="#passengerDisplayQR">QR</a>
                <a class="button is-link" onclick="shareTheData();">Share</a>
                <a class="button is-link is-danger"
                onclick="executeIfConfirmed(deleteCredential, 'Delete credential', 'Are you sure?', 'Credential deleted');">Delete</a>

            </div>
        </div>
    </div>

</div><!-- /page -->


<!-- =========================================== -->
<!-- RECEIVED CREDENTIAL DISPLAY PAGE             -->
<!-- =========================================== -->
<div id="displayReceivedCredentialPage" class="jrmpage">
    <script>
        pages["#displayReceivedCredentialPage"] = async function () {
            console.log("=> Inside #displayReceivedCredentialPage")
            displayCredentialPage("displayReceivedCredentialPlaceholder");
        }
    </script>

    <div id="displayReceivedCredentialPlaceholder"></div>

    <div class="section">
        <div class="container">
            <div class="buttons are-medium">
                <a class="button is-link" href="#passengerDisplayQR">Show QR</a>
                <a class="button is-link" onclick="history.back()">Cancel</a>
            </div>
        </div>
    </div>

</div><!-- /page -->









<script>
    async function deleteCredential() {

        console.log("Deleting credential", currentCredKey)
        await dbCredentials.removeItem(currentCredKey);
        await dbSettings.removeItem("passengerCredential");
        window.location = "#passengerCredList"

    }

</script>


<script>

async function shareTheData() {

    var file = new File([currentPassengerJWT], "credential.txt", {
        type: "text/plain",
    });
    var filesArray = [file]

    if (navigator.canShare && navigator.canShare({ files: filesArray })) {
        navigator.share({
            files: filesArray,
            title: 'Credential',
            text: currentPassengerJWT,
        })
        .then(() => alert('Share was successful.'));
//        .catch((error) => alert('Sharing failed', error));
    } else {
        alert(`Your system doesn't support sharing files.`);
    }

}

</script>

<!-- =========================================== -->
<!-- PASSENGER CREDENTIALQR POPUP -->
<!-- =========================================== -->
<div id="passengerDisplayQR" class="jrmpage">
    <script>
        pages["#passengerDisplayQR"] = async function () {
            console.log("=> Inside #passengerDisplayQR");
            passengerDisplayQR(currentPassengerJWT);
        }
    </script>

    <div class="section">
        <div class="container">

            <div class="card">
                <header class="card-header">
                    <p class="card-header-title">
                        Credential QR
                    </p>
                </header>
                <div class="card-content">

                    <div class="content" id="realqrcontent">

                        <img id="realplaceholderQR" src="" />
                        <div id="passengerDisplayQRMessage"></div>

                    </div>

                </div>
                <footer class="card-footer">
                    <p class="card-footer-item">
                        <a class="button is-link is-medium is-fullwidth" onclick="history.back()">Cancel</a>
                    </p>
                </footer>
            </div>

        </div>
    </div>

    <div id="placeholderQR"></div>

</div><!-- /page -->


<!-- =========================================== -->
<!-- VERIFIER HOME PAGE -->
<!-- =========================================== -->
<div id="verifierScanQR" class="jrmpage">
    <script>
        pages["#verifierScanQR"] = async function () {
            console.log("=> Inside #verifierScanQR")
            initiateReceiveQRScanning("verifierScanQR");
        }
    </script>

    <div class="section">
        <div class="container">

            <div class="card">
                <header class="card-header">
                    <p class="card-header-title">
                        Point to QR
                    </p>
                </header>
                <div class="card-content">
                    <div class="content">

                        <canvas class="qrcanvas" id="verifierScanQRCanvas" hidden></canvas>
                        </br>
                        <div id="verifierScanQRMessage">Waiting for QR ...</div>

                    </div>
                </div>
                <footer class="card-footer">
                    <div class="card-footer-item is-centered">
                        <div class="buttons are-medium">
                            <a class="button is-link" style="display: none;" id="verifierScanQRDecodeButton"
                                href="#displayReceivedQR">Decode data</a>
                            <a class="button is-danger" onclick="history.back()">Cancel</a>
                        </div>
                    </div>
                </footer>
            </div>
        </div>
    </div>

</div><!-- /page -->

<!-- =========================================== -->
<!-- DISPLAY RECEIVED QR PAGE -->
<!-- =========================================== -->
<div id="displayReceivedQR" class="jrmpage">
    <script>
        pages["#displayReceivedQR"] = async function () {
            console.log("=> Inside #displayReceivedQR")
        }
    </script>

    <div class="section">
        <div class="container">

            <div class="card">
                <header class="card-header">
                    <p class="card-header-title">
                        Passenger
                    </p>
                </header>
                <div class="card-content">
                    <div class="content">

                        <article>
                            <p class="is-size-6">Name: <b id="V_CITIZEN_NAME">Usobiaga, Victor</b></p>
                            <p class="is-size-6">ID type: <b id="V_CITIZEN_ID_TYPE">Usobiaga, Victor</b></p>
                            <p class="is-size-6">ID number: <b id="V_CITIZEN_VALID_ID_NUMBER">Usobiaga,
                                    Victor</b></p>
                            <p class="is-size-6">Phone: <b id="V_CITIZEN_CELL_PHONE">Usobiaga, Victor</b></p>
                            <p class="is-size-6">Mail: <b id="V_CITIZEN_EMAIL_ADDR">Usobiaga, Victor</b></p>
                        </article>

                    </div>
                </div>

            </div>

            </br>

            <div class="card">
                <header class="card-header">
                    <p class="card-header-title">
                        Diagnostic
                    </p>
                </header>
                <div class="card-content">
                    <div class="content">

                        <article>
                            <p class="is-size-6">Number: <b id="V_DIAGNOSTIC_NUMBER">Usobiaga, Victor</b></p>
                            <p class="is-size-6">Type: <b id="V_DIAGNOSTIC_TYPE">Usobiaga, Victor</b></p>
                            <p class="is-size-6">Time: <b id="V_TIMESTAMP">Usobiaga, Victor</b></p>
                            <p class="is-size-6">Result: <b id="V_DIAGNOSIS">Usobiaga, Victor</b></p>
                        </article>

                    </div>
                </div>
            </div>

            </br>

            <div class="card">
                <header class="card-header">
                    <p class="card-header-title">
                        Merchant
                    </p>
                </header>
                <div class="card-content">
                    <div class="content">

                        <article>
                            <p class="is-size-6">Merchant ID: <b id="V_MERCHANT_ID">Usobiaga, Victor</b></p>
                            <p class="is-size-6">Address: <b id="V_MERCHANT_ADDR">Usobiaga, Victor</b></p>

                            <p class="is-size-6">Operator ID: <b id="V_OPERATOR_ID">Usobiaga, Victor</b></p>
                            <p class="is-size-6">Cell phone: <b id="V_OPERATOR_CELL_PHONE_ID">Usobiaga, Victor</b>
                            </p>
                            <p class="is-size-6">GPS: <b id="V_OPERATOR_CELL_PHONE_GPS">Usobiaga, Victor</b></p>

                            <p class="is-size-6">Device ID: <b id="V_DEVICE_ID">Usobiaga, Victor</b></p>

                            <p class="is-size-6">Cartridge ID: <b id="V_CARTRIDGE_ID">Usobiaga, Victor</b></p>
                            <p class="is-size-6">Due date: <b id="V_CARTRIDGE_DUE_DATE">Usobiaga, Victor</b></p>

                        </article>

                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="section">
        <div class="container">
            <div class="buttons are-medium">
                <a class="button is-danger" onclick="history.back()">Cancel</a>
                <a class="button is-link" href="#homePage">Home</a>
            </div>
        </div>
    </div>

</div><!-- /page -->


<!-- =========================================== -->
<!-- ISSUER PAGE -->
<!-- =========================================== -->
<div id="issuerHome" class="jrmpage">
    <script>
        pages["#issuerHome"] = async function () {
            console.log("=> Inside #issuer")
            fillIssuerCredList();
        }
    </script>

    <div class="section">
        <div class="content">
            <h1>This is the issuer</h1>
            <p style="color: white;">This page is where data from the tests would be gathered in order to generate a certificate</p>
            <p style="color: white;">However, in order to facilitate things for the demo, we have precreated some certificates so
                the Issuer can be simulated and credentials sent to the customer.
            </p>
        </div>
    </div>

    <div class="section">
        <div class="container" id="issuer_cred_list">
        </div>
    </div>

</div><!-- /page -->

<script>
    function fillIssuerCredList() {

    // Retrieve the list of credentials from the server
    // The server must be the same one used by the verifier application
    var targetURL = apiHost + "/api/verifiable-credential/v1/credentials"
    $.get(targetURL, function (data) {
        console.log(data);
        // Fill the DOM of the verifier page with the received HTML
        // First remove all child elements
        $("#issuer_cred_list").empty();

        creds = data.payload;

        creds.forEach(get_issuer_cred_list);

    });

    }

    function get_issuer_cred_list(cred, index, array) {

    $("#issuer_cred_list").append(`<div class="card">
    <a onclick="transferViaQR('${cred}')">
        <header class="card-header">
            <p class="card-header-title">
                Diagnostic ID: ${cred}
            </p>
        </header>
    </a>
    </div>

    </br>`);

    }

</script>



<!-- =========================================== -->
<!-- CREDENTIALQR POPUP -->
<!-- =========================================== -->
<div class="jrmpage" id="genericDisplayQR">
    <script>
        pages["#genericDisplayQR"] = async function () {
            console.log("=> Inside #genericDisplayQR")
        }
    </script>

    <div class="section">
        <div class="container">

            <div class="card">
                <header class="card-header">
                    <p class="card-header-title">
                        Credential QR
                    </p>
                </header>
                <div class="card-content">
                    <div class="content">

                        <div id="genericPlaceholderQR"></div>

                    </div>
                </div>
                <footer class="card-footer">
                    <p class="card-footer-item">
                        <a class="button is-link is-medium is-fullwidth" onclick="history.back()">Cancel</a>
                    </p>
                </footer>
            </div>
        </div>
    </div>

</div><!-- /page -->

<!-- =========================================== -->
<!-- SETTINGS PAGE -->
<!-- =========================================== -->
<div id="settingsHome" class="jrmpage">
    <script>
        pages["#settingsHome"] = async function () {
            console.log("=> Inside #settings")
        }
    </script>

    <div class="section">
        <div class="container">

            <div class="card">
                <div class="card-content">
                    <p class="title">
                        Select server
                    </p>
                    <p class="subtitle">
                        Selects the server to use
                    </p>
                </div>

                <footer class="card-footer">
                    <div class="card-footer-item is-centered">
                        <div class="buttons are-medium">
                            <a class="button is-success" onclick="setApiHost(serverSameOrigin);">Development</a>
                            <a class="button is-danger" onclick="setApiHost(serverSafeIsland);">Production</a>
                        </div>
                    </div>
                </footer>



            </div>

            </br>

            <div class="card">
                <div class="card-content">
                    <p class="title">
                        Reset application
                    </p>
                    <p class="subtitle">
                        Deletes all credentials from the database and resets app
                    </p>
                </div>
                <footer class="card-footer">
                    <p class="card-footer-item">
                        <a class="button is-link is-danger"
                        onclick="executeIfConfirmed(resetCredStore, 'Delete database', 'Are you sure?', 'Database erased');">Reset</a>
                    </p>
                </footer>
            </div>

            </br>

            <div class="card">
                <div class="card-content">
                    <p class="title">
                        Add test credentials
                    </p>
                    <p class="subtitle">
                        Adds testing credentials
                    </p>
                </div>
                <footer class="card-footer">
                    <p class="card-footer-item">
                        <a class="button is-link is-medium is-fullwidth"
                            onclick="setTestingCredentials();">Add credentials</a>
                    </p>
                </footer>
            </div>

        </div>
    </div>

</div><!-- /page -->

<div id="msgDBReset" class="modal is-clipped" onclick='closeModal();'>
    <div class="modal-background" ></div>
    <div id="msgDBResetInner" class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Message</p>
            <!-- <button class="delete" aria-label="close" onclick="closeModal()"></button> -->
        </header>
        <section class="modal-card-body">
            <!-- Content ... -->
            <div class="content">
                <h3>DB was reset successfully</h3>
            </div>
        </section>
        <footer class="modal-card-foot">
            <p class="card-footer-item">
                <a class="button is-link is-medium is-fullwidth">OK</a>
            </p>
        </footer>

    </div>
</div>

<div id="msgConfirm" class="modal is-clipped">
    <div class="modal-background" ></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p id="msgTitle" class="modal-card-title">Are you sure?</p>
        </header>
        <section class="modal-card-body">
            <!-- Content ... -->
            <div class="content">
                <h3 id="msgText"></h3>
            </div>
        </section>
        <footer class="modal-card-foot">
            <p class="card-footer-item">
                <a id="msgOKButton" class="button is-danger is-medium" onclick="executeConfirmed()">OK</a>
                <a class="button is-link is-medium" onclick="closeModal();">Cancel</a>
            </p>
        </footer>
    </div>
</div>


<script>

var msgData = "";
function executeIfConfirmed(functionToExecute, confirmTitle, confirmText, confirmedText) {
    // Display a confirmation dialog and execute a function if OK pressed
//    console.log("In executeIfConfirmed",functionToExecute, confirmTitle);

    // Set the title and text of the confirmation dialog
    $("#msgTitle").html(confirmTitle);
    $("#msgText").html(confirmText);

    // Set the callback for when OK is pressed
    msgData = {fun: functionToExecute, text: confirmedText};

    $("#msgConfirm").addClass("is-active");

}

async function executeConfirmed() {
    console.log("Inside executeConfirmed");
    $(".modal").removeClass("is-active");
//    console.log("Message data:",msgData);
    await msgData.fun();
//    alert(msgData.text);
}

function openModal() {
    $(".modal").addClass("is-active");
}

function closeModal() {
    $(".modal").removeClass("is-active");
}
</script>

<!-- =========================================== -->
<!-- END SETTINGS PAGE -->
<!-- =========================================== -->



<!-- =========================================== -->
<!-- TEMPLATES FOR CREDENTIALS                   -->
<!-- =========================================== -->

<script>
    // The list of credential templates supported
    var credentialTemplatesSource = [
        "covidTestResult",
        "vaccinationCredential"
    ]

    var credentialTemplatesCompiled = []

    function compileCredentialTemplates() {

        for (i = 0; i < credentialTemplatesSource.length; i++) {
        	var templateName = credentialTemplatesSource[i];
            var templateSource = document.getElementById(templateName).innerHTML;
            var compiledTemplate = Handlebars.compile(templateSource);

            credentialTemplatesCompiled.push(compiledTemplate);
        }

    }

    function getTemplate(name) {
        console.log("template name", name)
        index = credentialTemplatesSource.indexOf(name);
        if (index == -1) {return undefined}
        return credentialTemplatesCompiled[index];
    }

    async function setTestingCredentials() {

        var testJWT = "eyJhbGciOiJFUzI1NksiLCJraWQiOiJkaWQ6ZWxzaTpWQVRFUy1YMTIzNDU2NzhYI2tleS12ZXJpZmljYXRpb24iLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE2MTM1NDEwNDUsImlhdCI6MTYxMzAyMjY0NSwiaXNzIjoiZGlkOmVsc2k6VkFURVMtWDEyMzQ1Njc4WCIsInN1YiI6Ijg3MzM1NjIwTCIsInV1aWQiOiIyM2EzNDBlZTVlODM0ZTBiOTYyYjQyZTFjMzlhZjgyZiIsInZjIjp7IkBjb250ZXh0IjpbImh0dHBzOi8vd3d3LnczLm9yZy8yMDE4L2NyZWRlbnRpYWxzL3YxIiwiaHR0cHM6Ly9hbGFzdHJpYS5naXRodWIuaW8vaWRlbnRpdHkvY3JlZGVudGlhbHMvdjEiLCJodHRwczovL3NhZmVpc2xhbmQub3JnLy53ZWxsLWtub3duL3czYy1jb3ZpZC10ZXN0L3YxIl0sImNyZWRlbnRpYWxTY2hlbWEiOnsiaWQiOiJjb3ZpZFRlc3RSZXN1bHQiLCJ0eXBlIjoiSnNvblNjaGVtYVZhbGlkYXRvcjIwMTgifSwiY3JlZGVudGlhbFN1YmplY3QiOnsiY292aWRUZXN0UmVzdWx0Ijp7ImFuYWx5c2lzIjp7ImRhdGUiOjE2MTMwMjI2NDUsImlkIjoiSVU0NTA5VkMiLCJyZXN1bHQiOiJGUkVFIiwidHlwZSI6IlBDUiIsInZlciI6IjEifSwiY29tbWVudHMiOiJUaGVzZSBhcmUgc29tZSBjb21tZW50cyIsImxhYiI6eyJhZGRyZXNzIjoiV29uZGVyZnVsIFN0cmVldCAxMjMsIFBlcmZlY3QgQ2l0eSwgVmFsaGFsbGEiLCJuYW1lIjoiUGVyZmVjdCBIZWFsdGggcGxjIiwicGhvbmUiOiIrMzQ2MzU0MDA0MDEifSwicGF0aWVudCI6eyJkb2IiOiIxMS0wNS0xOTc3IiwiaWRudW1iZXIiOiI4NzMzNTYyMEwiLCJuYW1lIjoiUEVSRVovUEVSSUNPIn19LCJpc3N1ZWRBdCI6WyJyZWR0LmFsYXN0cmlhIl0sImxldmVsT2ZBc3N1cmFuY2UiOjJ9LCJ0eXBlIjpbIlZlcmlmaWFibGVDcmVkZW50aWFsIiwiQWxhc3RyaWFWZXJpZmlhYmxlQ3JlZGVudGlhbCIsIlNhZmVJc2xhbmRDb3ZpZFRlc3RSZXN1bHQiXX19.vSTYIjTic2dIlp5COzobysRl7Kw6Nnh1qGyi8DP4rBHJDA1pzTvhLqegVCTWcKAPHDbLiGbT--xa1C0sgC3C1w"
        await dbCredentialsSetItem(testJWT)

        var testJWT = "eyJhbGciOiJFUzI1NksiLCJraWQiOiJkaWQ6ZWxzaTpWQVRFUy1YMTIzNDU2NzhYI2tleS12ZXJpZmljYXRpb24iLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE2MTM1NDEwNDYsImlhdCI6MTYxMzAyMjY0NiwiaXNzIjoiZGlkOmVsc2k6VkFURVMtWDEyMzQ1Njc4WCIsInN1YiI6Ijg3MzM1NjIwTCIsInV1aWQiOiIwZmQzOTEwZTUwODY0MWE0YmY5ZjNjYWMyNDBjY2RiMCIsInZjIjp7IkBjb250ZXh0IjpbImh0dHBzOi8vd3d3LnczLm9yZy8yMDE4L2NyZWRlbnRpYWxzL3YxIiwiaHR0cHM6Ly9hbGFzdHJpYS5naXRodWIuaW8vaWRlbnRpdHkvY3JlZGVudGlhbHMvdjEiLCJodHRwczovL3NhZmVpc2xhbmQub3JnLy53ZWxsLWtub3duL3czYy1jb3ZpZC10ZXN0L3YxIl0sImNyZWRlbnRpYWxTY2hlbWEiOnsiaWQiOiJ2YWNjaW5hdGlvbkNyZWRlbnRpYWwiLCJ0eXBlIjoiSnNvblNjaGVtYVZhbGlkYXRvcjIwMTgifSwiY3JlZGVudGlhbFN1YmplY3QiOnsiaXNzdWVkQXQiOlsicmVkdC5hbGFzdHJpYSJdLCJsZXZlbE9mQXNzdXJhbmNlIjoyLCJ2YWNjaW5hdGlvbkNyZWRlbnRpYWwiOnsiY29tbWVudHMiOiJUaGVzZSBhcmUgc29tZSBjb21tZW50cyIsInBhdGllbnQiOnsiZG9iIjoiMTEtMDUtMTk3NyIsImlkbnVtYmVyIjoiODczMzU2MjBMIiwibmFtZSI6IlBFUkVaL1BFUklDTyJ9LCJ2YWNjaW5hdGlvbiI6eyJhdXRoX2hvbGRlciI6IlBmaXplciBCaW9OVGVjaCIsImJhdGNoIjoiQUg2NTM3NFUiLCJjZW50ZXIiOiJQZXJmZWN0IEhlYWx0aCBwbGMiLCJjb3VudHJ5IjoiRVMiLCJkYXRlIjoxNjEzMDIyNjQ2LCJkaXNlYXNlIjoiQ09WSUQxOSIsImRvc2VfbnVtYmVyIjoiMSIsIm5leHRfZGF0ZSI6MTYxNTYxNDY0NiwicHJvZHVjdCI6IkNPTUlSTkFUWSBjb25jZW50cmF0ZSBmb3IgZGlzcGVyc2lvbiBmb3IgaW5qZWN0aW9uIiwicHJvZmVzc2lvbmFsIjoiRVM0NjEwNjUwOEgiLCJ0b3RhbF9kb3NlcyI6IjIiLCJ2YWNjaW5lIjoiMTExOTM0OTAwNyB8IENPVklELTE5IG1STkEgdmFjY2luZSJ9fX0sInR5cGUiOlsiVmVyaWZpYWJsZUNyZWRlbnRpYWwiLCJBbGFzdHJpYVZlcmlmaWFibGVDcmVkZW50aWFsIiwiU2FmZUlzbGFuZFZhY2NpbmF0aW9uQ3JlZGVudGlhbCJdfX0.1kVMhiI64XIHZ9KMrcAGIdKPBChEU2Xbwf560XyxmbpDtgTt-S8cP7V9QySWq3HWFB70lk47X_KPussswPWLNA"
        await dbCredentialsSetItem(testJWT)

    }

</script>


<script class="credentialTemplate" id="covidTestResult" type="text/x-handlebars-template">

    {{#with vc.credentialSubject.covidTestResult}}
    <div class="section">
        <div class="container">

            <!-- The content of the container is a template of a credential, filled with
                sample data. The individual fields inside the template are modified by the 
                functions receiving and retrieving actual credential data (in JSON format) -->

            <!-- PASSENGER CARD -->
            <div class="card">
                <header class="card-header">
                    <p class="card-header-title">
                        Passenger
                    </p>
                </header>
                <div class="card-content">
                    <div class="content">

                        <article>
                            <p class="is-size-6">Name: <b>{{patient.name}}</b></p>
                            <p class="is-size-6">ID number: <b>{{patient.idnumber}}</b></p>
                            <p class="is-size-6">Birth date: <b>{{patient.dob}}</b></p>
                        </article>

                    </div>
                </div>
            </div>
            </br>

            <!-- DIAGNOSTIC CARD -->
            <div class="card">
                <header class="card-header">
                    <p class="card-header-title">
                        Diagnostic
                    </p>
                </header>
                <div class="card-content">
                    <div class="content">

                        <article>
                            <p class="is-size-6">Number: <b>{{analysis.id}}</b></p>
                            <p class="is-size-6">Version: <b>{{analysis.ver}}</b></p>
                            <p class="is-size-6">Date: <b>{{analysis.date}}</b></p>
                            <p class="is-size-6">Type: <b>{{analysis.type}}</b></p>
                            <p class="is-size-6">Result: <b>{{analysis.result}}</b></p>
                        </article>

                    </div>
                </div>
            </div>

            </br>

            <!-- LABORATORY CARD -->
            <div class="card">
                <header class="card-header">
                    <p class="card-header-title">
                        Lab data
                    </p>
                </header>
                <div class="card-content">
                    <div class="content">

                        <article>
                            <p class="is-size-6">Name: <b>{{lab.name}}</b></p>
                            <p class="is-size-6">Address: <b>{{lab.address}}</b></p>
                            <p class="is-size-6">Phone: <b>{{lab.phone}}</b></p>
                        </article>

                    </div>
                </div>
            </div>

            </br>
        </div>
    </div>
    {{/with}}

</script>


<script class="credentialTemplate" id="vaccinationCredential" type="text/x-handlebars-template">

    {{#with vc.credentialSubject.vaccinationCredential}}
    <div class="section">
        <div class="container">

            <!-- The content of the container is a template of a credential, filled with
                sample data. The individual fields inside the template are modified by the 
                functions receiving and retrieving actual credential data (in JSON format) -->

            <!-- PERSON IDENTIFICATION CARD -->
            <div class="card">
                <header class="card-header">
                    <p class="card-header-title">
                        Person
                    </p>
                </header>
                <div class="card-content">
                    <div class="content">

                        <article>
                            <p class="is-size-6">Name: <b>{{patient.name}}</b></p>
                            <p class="is-size-6">Identifier: <b>{{patient.idnumber}}</b></p>
                            <p class="is-size-6">Birth date: <b>{{patient.dob}}</b></p>
                        </article>

                    </div>
                </div>
            </div>
            </br>

            <!-- VACCINATION CARD -->
            <div class="card">
                <header class="card-header">
                    <p class="card-header-title">
                        Vaccination
                    </p>
                </header>
                <div class="card-content">
                    <div class="content">

                        <article>
                            <p class="is-size-6">Disease target: <b>{{vaccination.disease}}</b></p>
                            <p class="is-size-6">Vaccine: <b>{{vaccination.vaccine}}</b></p>
                            <p class="is-size-6">Product: <b>{{vaccination.product}}</b></p>
                            <p class="is-size-6">Auth holder: <b>{{vaccination.auth_holder}}</b></p>
                            <p class="is-size-6">Dose Number: <b>{{vaccination.dose_number}}</b></p>
                            <p class="is-size-6">Total doses: <b>{{vaccination.total_doses}}</b></p>
                            <p class="is-size-6">Batch: <b>{{vaccination.batch}}</b></p>
                            <p class="is-size-6">Date: <b>{{vaccination.date}}</b></p>
                            <p class="is-size-6">Next date: <b>{{vaccination.next_date}}</b></p>

                            <p class="is-size-6">Center: <b>{{vaccination.center}}</b></p>
                            <p class="is-size-6">Health professional: <b>{{vaccination.professional}}</b></p>
                            <p class="is-size-6">Country: <b>{{vaccination.country}}</b></p>
                        </article>

                    </div>
                </div>
            </div>

            </br>

        </div>
    </div>
    {{/with}}

</script>

<!-- ================================ -->
<!-- END TEMPLATES FOR CREDENTIALS    -->
<!-- ================================ -->



<!-- ================================ -->
<!-- APPLICATION SCRIPT               -->
<!-- ================================ -->

<script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>

<script src="js/jquery-3.5.1.min.js"></script>

<script src="js/localforage.min.js"></script>

<script src="js/app.js"></script>

<!-- Javascript for scanning a QR -->
<script src="js/jsQR.js"></script>

<!-- Javascript for creating a QR -->
<script src="js/easy.qrcode.min.js"></script>

</body>

</html>