<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Verifiable Credentials for a Safe Island">
    <meta name="theme-color" content="#2F3BA2" />
    <title>Safe Island</title>

    <!-- Font Awesome Free 5.15.1 -->
    <link rel="stylesheet" href="css/all.css">

    <!-- Customized Bulma 0.9.1 CSS framework -->
    <link rel="stylesheet" href="css/mystyles.css">

    <!-- Specific CSS for this project -->
    <link rel="stylesheet" href="css/safeisland.css">

    <link rel="manifest" href="/manifest.json">

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="SafeIsland">
    <link rel="apple-touch-icon" href="img/icon-152.png">

    <style>
        /* Center the loader */
        #loader {
            position: absolute;
            left: 50%;
            top: 50%;
            z-index: 1;
        }

        .jrmpage {
            display: none;
        }

    </style>

</head>

<body>
<script>
    // Initialize the array of pages in the application
    var pages = {}
</script>
    
<div class="columns" style="margin-left: 0; margin-right: 0;">
    <div class="column is-half is-offset-one-quarter">


    <span id="loader" class="icon">
        <i class="fas fa-spinner fa-spin fa-5x"></i>
    </span>


<!-- =========================================== -->
<!-- NAVIGATION BAR -->
<!-- =========================================== -->

    <nav id="appNavbar" class="navbar mb-4" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="#homePage">
                <img src="img/Logo.png" width="112" height="35">
            </a>

            <div class="buttons">
                <button class="button is-primary" style="display: none;" id="butInstall" aria-label="Install">Install
                    locally</button>
            </div>
            
            <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="settingsMenu">
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
            </a>
        </div><!-- /navbar-brand -->

        <div id="settingsMenu" class="navbar-menu">

            <div class="navbar-end">
        
                <div class="navbar-item has-dropdown is-hoverable">
                    <a class="navbar-link is-primary">
                        Menu
                    </a>
        
                    <div class="navbar-dropdown is-right">
                        <a class="navbar-item" href="#settingsHome" onclick="menuClose();">
                            Settings
                        </a>
                        <hr class="navbar-divider">
                        <a class="navbar-item">
                            Help
                        </a>
                    </div><!-- /navbar-dropdown -->
                </div><!-- /navbar-item -->
            </div><!-- /navbar-end -->

        </div>

    </nav>

    </div>
</div>
<!-- =========================================== -->
<!-- END NAVIGATION BAR -->
<!-- =========================================== -->

<div class="columns" style="margin-left: 0; margin-right: 0;">
    <div class="column is-half is-offset-one-quarter">

<!-- =========================================== -->
<!-- HOME PAGE -->
<!-- =========================================== -->
<script>
    pages["#homePage"] = async function () {
        console.log("=> Inside home")
        $("#homePage").show();
    }
</script>

<div id="homePage" class="jrmpage container">

    <div class="card mb-5 has-text-centered">
        <a href="#passengerHome">
            <div class="card-content is-primary">
                <p class="title">
                    I am a Passenger
                </p>
                <p class="subtitle">
                    Receive or show your test results
                </p>

            </div>
        </a>
    </div><!-- /card -->

    <div class="card my-5 has-text-centered">
        <a href="#verifierScanQR">
            <div class="card-content">
                <p class="title">
                    I am a Controller
                </p>
                <p class="subtitle">
                    Review the test results of a passenger
                </p>
            </div>
        </a>
    </div><!-- /card -->

    <div class="card mt-5 has-text-centered">
        <a href="#issuerHome">
            <div class="card-content">
                <p class="title">
                    I am an Issuer
                </p>
                <p class="subtitle">
                    Check my lab test results
                </p>
            </div>
        </a>
    </div><!-- /card -->

</div><!-- /page -->


<!-- =========================================== -->
<!-- PASSENGER HOME PAGE -->
<!-- =========================================== -->
<script>
    pages["#passengerHome"] = async function () {
        console.log("=> Inside #homePassenger")
        $("#passengerHome").show();
    }
</script>

<div id="passengerHome" class="jrmpage container">

    <div class="card mb-5 has-text-centered">
        <a href="#passengerQRScan">
            <div class="card-content is-primary">
                <p class="title">
                    Receive a credential
                </p>
                <p class="subtitle">
                    Scan a QR and store the credential
                </p>

            </div>
        </a>
    </div><!-- /card -->

    <div class="card mb-5 has-text-centered">
        <a href="#passengerCredList">
            <div class="card-content is-primary">
                <p class="title">
                    View my credentials
                </p>
                <p class="subtitle">
                    Review and manage my credentials
                </p>

            </div>
        </a>
    </div><!-- /card -->

</div><!-- /page -->


<!-- =========================================== -->
<!-- PASSENGER QR SCANNING PAGE -->
<!-- =========================================== -->
<script>
    pages["#passengerQRScan"] = async function () {
        console.log("=> Inside #passengerQRScan")
        await dbSettings.setItem("displayCredentialPageQR", false);
        await dbSettings.setItem("displayCredentialPageSave", true);
        await dbSettings.setItem("displayCredentialPageDelete", false);
        await dbSettings.setItem("displayCredentialPageShare", false);
        $("#passengerQRScan").show();
        initiateReceiveQRScanning("#passengerQRScan", "#qrCanvas", "#qrMessage", "#displayCredentialPage");
    }
</script>

<div id="passengerQRScan" class="jrmpage container">

    <div class="card my-1 has-text-centered">

        <div class="card-content" id="passengerQRScanCard">
            <div class="content">
                <p >
                    Point to QR from Issuer
                </p>
    
                <canvas class="qrcanvas" id="qrCanvas" style="width: 100%;" hidden></canvas>
                </br>
                <div id="qrMessage">Waiting for QR ...</div>

            </div>
        </div>

        <footer class="card-footer">
            <div class="card-footer-item is-centered">
                <div class="buttons are-medium">
                    <a class="button is-primary" onclick="history.back()">Cancel</a>
                </div>
            </div>
        </footer>

    </div><!-- /card -->

</div><!-- /page -->



<!-- =========================================== -->
<!-- PASSENGER CREDENTIAL LIST PAGE -->
<!-- =========================================== -->
<script>
    pages["#passengerCredList"] = async function () {
        console.log("=> Inside #passengerCredList")
        await fillPassengerCredList();
        $("#passengerCredList").show();
    }
</script>

<div id="passengerCredList" class="jrmpage container">

    <div class="content">
        <h2>List of credentials</h2>
    </div>

    <!-- This is a placeholder that will be filled  by the fillPassengerCredList function -->
    <div class="container" id="passenger_cred_list"></div>

</div><!-- /page -->

<script>
    console.log("Passenger list page init")
</script>

<script>

    // Gets one credential from the local DB, sets it as default and switches to the display page 
    async function displayCredentialFromKey(key) {
        // Get the specified credential from the credential store
        currentCredential = await dbCredentials.getItem(key);

        // Store in temporal storage so the page will retrieve it
        await dbSettings.setItem("currentCredential", currentCredential);
        await dbSettings.setItem("currentCredentialKey", key);

        // Initiate transition to the display credential page
        await dbSettings.setItem("displayCredentialPageQR", true);
        await dbSettings.setItem("displayCredentialPageSave", false);
        await dbSettings.setItem("displayCredentialPageDelete", true);
        await dbSettings.setItem("displayCredentialPageShare", true);
        window.location = "#displayCredentialPage";

    }


    async function fillPassengerCredList() {
        // Fill the DOM of the verifier page with the received HTML
        // First remove all child elements
        $("#passenger_cred_list").empty();

        keys = await dbAllCredentials();
        if (keys == null) {
            $("#passenger_cred_list").text("Currently you do not have credentials.");
            return;
        }

        html = ""
        for (i = 0; i < keys.length; i++) {

            var key = keys[i]
            var credential = await dbCredentials.getItem(key);
            var credentialType = credential["type"]
            var credentialDecoded = credential["decoded"]
            var cred = ""
            var analysisDate = ""
            var cred_date = ""
            var displayName = ""
            var personName = ""
            
            // get the credential schema

            console.log(credentialType)
            if (credentialType == "ukimmigration") {
                schema = "ukimmigration"
                displayName = "UK Visa & Immigration"
                cred = credentialDecoded
                cred_date = cred["ts"]
                personName = cred["ln"] + " " + cred["fn"]
            } else {

                var schema = credentialDecoded['body']['vc']['credentialSchema']['id']

                if (schema == "covidTestResult") {
                    displayName = "Covid19 certificate"
                    cred = credentialDecoded['body']['vc']['credentialSubject']['covidTestResult'];
                    analysisDate = cred['analysis']['date']
                }

                if (schema == "vaccinationCredential") {
                    displayName = "Vaccination certificate"
                    cred = credentialDecoded['body']['vc']['credentialSubject']['vaccinationCredential'];
                    analysisDate = cred['vaccination']['date']
                }
                cred_date = new Date(analysisDate * 1000);
                cred_date = cred_date.toISOString()
                personName = cred['patient']['name']
            }


            if (cred == "") {
                console.log("Error: credential not recognized")
                return
            }


            html = html + `
            <div class="card my-3">
                <a onclick="displayCredentialFromKey('${key}')">
                    <header class="card-header">
                        <p class="card-header-title">
                            ${displayName}
                        </p>
                    </header>
                    <div class="card-content ">
                        <div class="content">
                            <p>${cred_date}</p>
                            <p>${personName}</p>
                        </div>

                    </div>

                </a>
            </div>
            
            `
        }

        $("#passenger_cred_list").html(html)

    }


    async function dbAllCredentials() {

        keys = await dbCredentials.keys();
        console.log(keys);

        // Check if there are keys
        if (keys == null || keys.length == 0) {
            return null;
        }

        // Sort the array in reverse order: newest first
        keys.sort().reverse();

        return keys

    }

</script>
<!-- =========================================== -->
<!-- END PASSENGER CREDENTIAL LIST PAGE -->
<!-- =========================================== -->




<!-- =========================================== -->
<!-- GENERIC CREDENTIAL DISPLAY PAGE             -->
<!-- =========================================== -->
<script>
    var displayCredentialPageQR = false
    var displayCredentialPageSave = false
    var displayCredentialPageDelete = false
    var displayCredentialPageShare = false

    pages["#displayCredentialPage"] = async function () {
        console.log("=> Inside #displayCredentialPage")
        var currentCredential = await getSetting("currentCredential")
        displayCredentialPage("#displayCredentialPage", "#placeHolder", currentCredential);
        $("#displayCredentialPage").show();
    }
</script>

<div id="displayCredentialPage" class="jrmpage container">

    <div id="placeHolder"></div>

    <div class="container">
        <div class="buttons are-medium">
            <a id="displayCredentialPageQR" class="button is-primary" href="#passengerDisplayQR">QR</a>
            <a id ="displayCredentialPageShare" class="button is-primary" onclick="shareTheData();">Share</a>
            <a id="displayCredentialPageSave" class="button is-primary" onclick="saveCredential();">Save</a>
            <a id="displayCredentialPageDelete" class="button is-danger"
            onclick="executeIfConfirmed(deleteCredential, 'Delete credential', 'Are you sure?', 'Credential deleted');">Delete</a>

        </div>
    </div>

</div><!-- /page -->


<!-- =========================================== -->
<!-- RECEIVED CREDENTIAL DISPLAY PAGE            -->
<!-- =========================================== -->
<script>
    pages["#displayReceivedCredentialPage"] = async function () {
        console.log("=> Inside #displayReceivedCredentialPage")
        var currentCredential = await getSetting("currentCredential")
        displayCredentialPage("#displayReceivedCredentialPage", "#placeHolder", currentCredential);
        $("#displayReceivedCredentialPage").show();
    }
</script>

<div id="displayReceivedCredentialPage" class="jrmpage container">

    <div id="placeHolder"></div>

    <div class="container">
        <div class="buttons are-medium">
            <a class="button is-primary" href="#passengerDisplayQR">QR</a>
            <a class="button is-primary" onclick="history.back()">Back</a>
        </div>
    </div>

</div><!-- /page -->


<script>

    async function saveCredential() {
        var currentCredential = await dbSettings.getItem("currentCredential");
        await dbCredentialsSetItem(currentCredential);
        console.log("Saving", currentCredential)
        window.location = "#passengerCredList";
    }

    async function deleteCredential() {

        var currentCredentialKey = await dbSettings.getItem("currentCredentialKey")
        console.log("Deleting credential", currentCredentialKey)
        await dbCredentials.removeItem(currentCredentialKey);
        await dbSettings.removeItem("currentCredential");
        await dbSettings.removeItem("currentCredentialKey");
        window.location = "#passengerCredList";

    }

</script>


<script>

async function shareTheData() {

    var currentJWT = await getSetting("currentJWT")

    var file = new File([currentJWT], "credential.txt", {
        type: "text/plain",
    });
    var filesArray = [file]

    if (navigator.canShare && navigator.canShare({ files: filesArray })) {
        navigator.share({
            files: filesArray,
            title: 'Credential',
            text: currentJWT,
        })
        .then(() => alert('Share was successful.'));
//        .catch((error) => alert('Sharing failed', error));
    } else {
        alert(`Your system doesn't support sharing files.`);
    }

}

</script>

<!-- =========================================== -->
<!-- PASSENGER DISPLAY QR                        -->
<!-- =========================================== -->
<script>
    pages["#passengerDisplayQR"] = async function () {
        console.log("=> Inside #passengerDisplayQR");
        var currentCredential = await getSetting("currentCredential")
        $("#passengerDisplayQR").show();
        passengerDisplayQR(currentCredential);
    }
</script>

<div id="passengerDisplayQR" class="jrmpage container">

    <div class="card has-text-centered">
        <header class="card-header">
            <p class="card-header-title">
                Credential QR
            </p>
        </header>
        <div class="card-content">

            <div class="content" id="realqrcontent">

                <div class="columns ">
                    <div class="column is-narrow">
                        <img id="realplaceholderQR" src="" />
                    </div>
                </div>
        
                <div id="passengerDisplayQRMessage"></div>

            </div>

        </div>
        <footer class="card-footer">
            <p class="card-footer-item">
                <a class="button is-primary is-medium" onclick="history.back()">&nbsp;&nbsp;&nbsp;Cancel&nbsp;&nbsp;&nbsp;</a>
            </p>
        </footer>
    </div>

    <div id="placeholderQR"></div>

</div><!-- /page -->


<!-- =========================================== -->
<!-- VERIFIER HOME PAGE -->
<!-- =========================================== -->
<script>
    pages["#verifierScanQR"] = async function () {
        console.log("=> Inside #verifierScanQR")
        await dbSettings.setItem("displayCredentialPageQR", false);
        await dbSettings.setItem("displayCredentialPageSave", false);
        await dbSettings.setItem("displayCredentialPageDelete", false);
        await dbSettings.setItem("displayCredentialPageShare", false);
        $("#verifierScanQR").show();
        initiateReceiveQRScanning("#verifierScanQR", "#qrCanvas", "#qrMessage", "#displayCredentialPage");
    }
</script>

<div id="verifierScanQR" class="jrmpage container">

    <div class="card">
        <header class="card-header">
            <p class="card-header-title">
                Point to QR
            </p>
        </header>
        <div class="card-content" id="verifierQRScanCard">
            <div class="content">

                <canvas class="qrcanvas" id="qrCanvas" style="width: 100%;" hidden></canvas>
                </br>
                <div id="qrMessage">Waiting for QR ...</div>

            </div>
        </div>
        <footer class="card-footer">
            <div class="card-footer-item is-centered">
                <div class="buttons are-medium">
                    <a class="button is-primary" onclick="history.back()">Cancel</a>
                </div>
            </div>
        </footer>
    </div><!-- /card -->

</div><!-- /page -->


<!-- =========================================== -->
<!-- ISSUER PAGE -->
<!-- =========================================== -->
<script>
    pages["#issuerHome"] = async function () {
        console.log("=> Inside #issuer")
        fillIssuerCredList();
        $("#issuerHome").show();
    }
</script>

<div id="issuerHome" class="jrmpage container">

    <div class="content">
        <h1>This is the issuer</h1>
        <p>This page is where data from the tests would be gathered in order to generate a certificate</p>
        <p>However, in order to facilitate things for the demo, we have precreated some certificates so
            the Issuer can be simulated and credentials sent to the customer.
        </p>
    </div>

    <div class="container" id="issuer_cred_list"></div>

</div><!-- /page -->

<script>
    function fillIssuerCredList() {

    // Retrieve the list of credentials from the server
    // The server must be the same one used by the verifier application
    console.log("APIHost:", apiHost)
    var targetURL = apiHost + "/api/verifiable-credential/v1/credentials"
    $.get(targetURL, function (data) {
        console.log(data);
        // Fill the DOM of the verifier page with the received HTML
        // First remove all child elements
        $("#issuer_cred_list").empty();

        creds = data.payload;

        creds.forEach(get_issuer_cred_list);

    });

    }

    function get_issuer_cred_list(credential, index, array) {

        console.log(credential)
        var credentialDecoded = decodeJWT(credential["cert"])
        var schema = credentialDecoded['body']['vc']['credentialSchema']['id']

        var displayName = ""
        var cred_date = ""
        var analysisDate = ""

        if (schema == "covidTestResult") {
            displayName = "Covid19 certificate"
            cred = credentialDecoded['body']['vc']['credentialSubject']['covidTestResult'];
            analysisDate = cred['analysis']['date']
        }

        if (schema == "vaccinationCredential") {
            displayName = "Vaccination certificate"
            cred = credentialDecoded['body']['vc']['credentialSubject']['vaccinationCredential'];
            analysisDate = cred['vaccination']['date']
        }
        cred_date = new Date(analysisDate * 1000);
        cred_date = cred_date.toISOString()
        var personName = cred['patient']['name']



    $("#issuer_cred_list").append(`<div class="card">
    <a onclick="transferViaQR('${credential["cert"]}')">
        <header class="card-header">
            <p class="card-header-title">
                ${schema}
            </p>
        </header>
        <div class="card-content ">
            <div class="content">
                <p>${cred_date}</p>
                <p>${personName}</p>
            </div>

        </div>


    </a>
    </div>

    </br>`);

    }

</script>



<!-- =========================================== -->
<!-- CREDENTIALQR POPUP -->
<!-- =========================================== -->
<div class="jrmpage" id="genericDisplayQR">
    <script>
        pages["#genericDisplayQR"] = async function () {
            console.log("=> Inside #genericDisplayQR")
            $("#genericDisplayQR").show();
        }
    </script>

    <div class="section">
        <div class="container">

            <div class="card">
                <header class="card-header">
                    <p class="card-header-title">
                        Credential QR
                    </p>
                </header>
                <div class="card-content">
                    <div class="content">

                        <div id="genericPlaceholderQR"></div>

                    </div>
                </div>
                <footer class="card-footer">
                    <p class="card-footer-item">
                        <a class="button is-primary is-medium is-fullwidth" onclick="history.back()">Cancel</a>
                    </p>
                </footer>
            </div>
        </div>
    </div>

</div><!-- /page -->

<!-- =========================================== -->
<!-- SETTINGS PAGE -->
<!-- =========================================== -->
<script>
    pages["#settingsHome"] = async function () {
        console.log("=> Inside #settings")
        $("#settingsHome").show();
    }
</script>

<div id="settingsHome" class="jrmpage container">

    <div class="card has-text-centered">
        <div class="card-content">
            <p class="title">
                Select server
            </p>
            <p class="subtitle">
                Selects the server to use
            </p>
        </div>

        <footer class="card-footer">
            <div class="card-footer-item is-centered">
                <div class="buttons are-medium">
                    <a class="button is-primary" onclick="setApiHost(serverSameOrigin);">Development</a>
                    <a class="button is-danger" onclick="setApiHost(serverSafeIsland);">Production</a>
                </div>
            </div>
        </footer>

    </div>

    </br>

    <div class="card has-text-centered">
        <div class="card-content">
            <p class="title">
                Reset application
            </p>
            <p class="subtitle">
                Deletes all credentials from the database and resets app
            </p>
        </div>
        <footer class="card-footer">
            <p class="card-footer-item">
                <a class="button is-medium is-danger"
                onclick="executeIfConfirmed(resetCredStore, 'Delete database', 'Are you sure?', 'Database erased');">Reset application</a>
            </p>
        </footer>
    </div>

    </br>

    <div class="card has-text-centered">
        <div class="card-content">
            <p class="title">
                Add test credentials
            </p>
            <p class="subtitle">
                Adds testing credentials
            </p>
        </div>
        <footer class="card-footer">
            <p class="card-footer-item">
                <a class="button is-primary is-medium"
                    onclick="setTestingCredentials();">Add credentials</a>
            </p>
        </footer>
    </div>


</div><!-- /page -->

<div id="msgDBReset" class="modal is-clipped" onclick='closeModal();'>
    <div class="modal-background" ></div>
    <div id="msgDBResetInner" class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Message</p>
            <!-- <button class="delete" aria-label="close" onclick="closeModal()"></button> -->
        </header>
        <section class="modal-card-body">
            <!-- Content ... -->
            <div class="content">
                <h3>DB was reset successfully</h3>
            </div>
        </section>
        <footer class="modal-card-foot">
            <p class="card-footer-item">
                <a class="button is-primary is-medium is-fullwidth">OK</a>
            </p>
        </footer>

    </div>
</div>

<div id="msgConfirm" class="modal is-clipped">
    <div class="modal-background" ></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p id="msgTitle" class="modal-card-title">Are you sure?</p>
        </header>
        <section class="modal-card-body">
            <!-- Content ... -->
            <div class="content">
                <h3 id="msgText"></h3>
            </div>
        </section>
        <footer class="modal-card-foot">
            <p class="card-footer-item">
                <a id="msgOKButton" class="button is-danger is-medium" onclick="executeConfirmed()">OK</a>
                <a class="button is-primary is-medium" onclick="closeModal();">Cancel</a>
            </p>
        </footer>
    </div>
</div>


<script>

var msgData = "";
function executeIfConfirmed(functionToExecute, confirmTitle, confirmText, confirmedText) {
    // Display a confirmation dialog and execute a function if OK pressed
//    console.log("In executeIfConfirmed",functionToExecute, confirmTitle);

    // Set the title and text of the confirmation dialog
    $("#msgTitle").html(confirmTitle);
    $("#msgText").html(confirmText);

    // Set the callback for when OK is pressed
    msgData = {fun: functionToExecute, text: confirmedText};

    $("#msgConfirm").addClass("is-active");

}

async function executeConfirmed() {
    console.log("Inside executeConfirmed");
    $(".modal").removeClass("is-active");
//    console.log("Message data:",msgData);
    await msgData.fun();
//    alert(msgData.text);
}

function openModal() {
    $(".modal").addClass("is-active");
}

function closeModal() {
    $(".modal").removeClass("is-active");
}
</script>


    </div><!-- /column -->
</div><!-- /columns -->

<!-- =========================================== -->
<!-- END SETTINGS PAGE -->
<!-- =========================================== -->



<!-- =========================================== -->
<!-- TEMPLATES FOR CREDENTIALS                   -->
<!-- =========================================== -->

<script>
    // The list of credential templates supported
    var credentialTemplatesName = [
        "covidTestResult",
        "vaccinationCredential",
        "ukimmigration"
    ]

    var credentialTemplatesCompiled = []

    function compileCredentialTemplates() {

        for (i = 0; i < credentialTemplatesName.length; i++) {
        	var templateName = credentialTemplatesName[i];
            var templateSource = document.getElementById(templateName).innerHTML;
            var compiledTemplate = Handlebars.compile(templateSource);

            credentialTemplatesCompiled.push(compiledTemplate);
        }

    }

    function getTemplate(name) {
        console.log("template name", name)
        index = credentialTemplatesName.indexOf(name);
        if (index == -1) {return undefined}
        return credentialTemplatesCompiled[index];
    }

    async function setTestingCredentials() {

        var jwt = "eyJhbGciOiJFUzI1NksiLCJraWQiOiJkaWQ6ZWxzaTpWQVRFUy1CNjA2NDU5MDAja2V5LXZlcmlmaWNhdGlvbiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2MTUwNTc5NjYsImlhdCI6MTYxNDc5OTY1NCwiaXNzIjoiZGlkOmVsc2k6VkFURVMtQjYwNjQ1OTAwIiwic3ViIjoiWTA5MjcyMzBFIiwidXVpZCI6IiIsInZjIjp7IkBjb250ZXh0IjpbImh0dHBzOi8vd3d3LnczLm9yZy8yMDE4L2NyZWRlbnRpYWxzL3YxIiwiaHR0cHM6Ly9hbGFzdHJpYS5naXRodWIuaW8vaWRlbnRpdHkvY3JlZGVudGlhbHMvdjEiLCJodHRwczovL3NhZmVpc2xhbmQub3JnLy53ZWxsLWtub3duL3czYy1jb3ZpZC10ZXN0L3YxIl0sImNyZWRlbnRpYWxTY2hlbWEiOnsiaWQiOiJjb3ZpZFRlc3RSZXN1bHQiLCJ0eXBlIjoiSnNvblNjaGVtYVZhbGlkYXRvcjIwMTgifSwiY3JlZGVudGlhbFN1YmplY3QiOnsiY292aWRUZXN0UmVzdWx0Ijp7ImFuYWx5c2lzIjp7ImRhdGUiOjE2MTQ3OTg3NjYsImlkIjoiQU5UMTIzIiwicmVzdWx0IjoiRlJFRSIsInR5cGUiOiJQQ1IiLCJ2ZXIiOiIxIn0sImNvbW1lbnRzIjoiw6nDqmbDocOjw7HFhCIsImxhYiI6eyJhZGRyZXNzIjoiVHJhdmVzc2VyYSBkZSBHcsOgY2lhIDczLCDDgXRpY28gMDgwMDYgQmFyY2Vsb25hIFNQQUlOIChFUykiLCJuYW1lIjoiSU4yIiwicGhvbmUiOiIrMzQ5MDI4ODE3NzYifSwicGF0aWVudCI6eyJkb2IiOiIxMi0wNS0xOTc1IiwiaWRudW1iZXIiOiJZMDkyNzIzMEUiLCJuYW1lIjoiVVLDjUEvU0lMw49BIn19LCJpc3N1ZWRBdCI6WyJyZWR0LmFsYXN0cmlhIl0sImxldmVsT2ZBc3N1cmFuY2UiOjJ9LCJ0eXBlIjpbIlZlcmlmaWFibGVDcmVkZW50aWFsIiwiQWxhc3RyaWFWZXJpZmlhYmxlQ3JlZGVudGlhbCIsIlNhZmVJc2xhbmRDb3ZpZFRlc3RSZXN1bHQiXX19.DSQtHfyeClzNkQk93XfhEnG3AHxnzA1m-5ECP4xoENnmuPlUDff4xGohHpwpRLZdmFwIQoVGrZnMlDEX1Tw8tw"
        var cred = decodeJWT(jwt);
        console.log(cred)

        // Store the ceredential record
        currentCredential = {
            type: "w3cvc",
            encoded: jwt,
            decoded: cred
        }
        await dbCredentialsSetItem(currentCredential)


    }

</script>


<script class="credentialTemplate" id="covidTestResult" type="text/x-handlebars-template">

    {{#with vc.credentialSubject.covidTestResult}}
        <div class="container">

            <!-- The content of the container is a template of a credential, filled with
                sample data. The individual fields inside the template are modified by the 
                functions receiving and retrieving actual credential data (in JSON format) -->

            <!-- PASSENGER CARD -->
            <div class="card mb-3">
                <header class="card-header">
                    <p class="card-header-title">
                        Passenger
                    </p>
                </header>
                <div class="card-content">
                    <div class="content">

                        <article>
                            <p class="is-size-6">Name: <b>{{patient.name}}</b></p>
                            <p class="is-size-6">ID number: <b>{{patient.idnumber}}</b></p>
                            <p class="is-size-6">Birth date: <b>{{patient.dob}}</b></p>
                        </article>

                    </div>
                </div>
            </div>

            <!-- DIAGNOSTIC CARD -->
            <div class="card my-3">
                <header class="card-header">
                    <p class="card-header-title">
                        Diagnostic
                    </p>
                </header>
                <div class="card-content">
                    <div class="content">

                        <article>
                            <p class="is-size-6">Number: <b>{{analysis.id}}</b></p>
                            <p class="is-size-6">Version: <b>{{analysis.ver}}</b></p>
                            <p class="is-size-6">Date: <b>{{analysis.date}}</b></p>
                            <p class="is-size-6">Type: <b>{{analysis.type}}</b></p>
                            <p class="is-size-6">Result: <b>{{analysis.result}}</b></p>
                        </article>

                    </div>
                </div>
            </div>
            
            <!-- LABORATORY CARD -->
            <div class="card mt-3 mb-5">
                <header class="card-header">
                    <p class="card-header-title">
                        Lab data
                    </p>
                </header>
                <div class="card-content">
                    <div class="content">

                        <article>
                            <p class="is-size-6">Name: <b>{{lab.name}}</b></p>
                            <p class="is-size-6">Address: <b>{{lab.address}}</b></p>
                            <p class="is-size-6">Phone: <b>{{lab.phone}}</b></p>
                        </article>

                    </div>
                </div>
            </div>

        </div>
    {{/with}}

</script>


<script class="credentialTemplate" id="vaccinationCredential" type="text/x-handlebars-template">

    {{#with vc.credentialSubject.vaccinationCredential}}
        <div class="container">

            <!-- The content of the container is a template of a credential, filled with
                sample data. The individual fields inside the template are modified by the 
                functions receiving and retrieving actual credential data (in JSON format) -->

            <!-- PERSON IDENTIFICATION CARD -->
            <div class="card mb-3">
                <header class="card-header">
                    <p class="card-header-title">
                        Person
                    </p>
                </header>
                <div class="card-content">
                    <div class="content">

                        <article>
                            <p class="is-size-6">Name: <b>{{patient.name}}</b></p>
                            <p class="is-size-6">Identifier: <b>{{patient.idnumber}}</b></p>
                            <p class="is-size-6">Birth date: <b>{{patient.dob}}</b></p>
                        </article>

                    </div>
                </div>
            </div>

            <!-- VACCINATION CARD -->
            <div class="card mt-3 mb-5">
                <header class="card-header">
                    <p class="card-header-title">
                        Vaccination
                    </p>
                </header>
                <div class="card-content">
                    <div class="content">

                        <article>
                            <p class="is-size-6">Disease target: <b>{{vaccination.disease}}</b></p>
                            <p class="is-size-6">Vaccine: <b>{{vaccination.vaccine}}</b></p>
                            <p class="is-size-6">Product: <b>{{vaccination.product}}</b></p>
                            <p class="is-size-6">Auth holder: <b>{{vaccination.auth_holder}}</b></p>
                            <p class="is-size-6">Dose Number: <b>{{vaccination.dose_number}}</b></p>
                            <p class="is-size-6">Total doses: <b>{{vaccination.total_doses}}</b></p>
                            <p class="is-size-6">Batch: <b>{{vaccination.batch}}</b></p>
                            <p class="is-size-6">Date: <b>{{vaccination.date}}</b></p>
                            <p class="is-size-6">Next date: <b>{{vaccination.next_date}}</b></p>

                            <p class="is-size-6">Center: <b>{{vaccination.center}}</b></p>
                            <p class="is-size-6">Health professional: <b>{{vaccination.professional}}</b></p>
                            <p class="is-size-6">Country: <b>{{vaccination.country}}</b></p>
                        </article>

                    </div>
                </div>
            </div>

        </div>
    {{/with}}

</script>


<script class="credentialTemplate" id="ukimmigration" type="text/x-handlebars-template">

    <div class="container">

        <!-- The content of the container is a template of a credential, filled with
            sample data. The individual fields inside the template are modified by the 
            functions receiving and retrieving actual credential data (in JSON format) -->

        <!-- PERSON IDENTIFICATION CARD -->
        <div class="card mb-3">
            <header class="card-header">
                <p class="card-header-title">
                    UK Visas & Immigration
                </p>
            </header>
            <div class="card-content">
                <div class="content">

<!--                         <p class="is-size-4">Name: <b>{{ln}}/{{fn}}</b></p>
                        <p class="is-size-4">Passport: <b>{{di}}</b></p>
                        <p class="is-size-4">Date: <b>{{ts}}</b></p>
                        <p class="is-size-4">Reference: <b>{{rf}}</b></p>
                        
                        {{#each tg}}
                        <p class="is-size-4">Phone: <b>+{{this.code}} {{this.number}}</b></p>

                        {{/each}}

                        <p class="is-size-4">Address: <b>{{qa}}</b></p>
                        <p class="is-size-4">Signature: <b>{{sn}}</b></p>
 -->

                        <p>Name: <b>{{ln}}/{{fn}}</b></p>
                        <p>Passport: <b>{{di}}</b></p>
                        <p>Date: <b>{{ts}}</b></p>
                        <p>Reference: <b>{{rf}}</b></p>
                        
                        {{#each tg}}
                        <p>Phone: <b>+{{this.code}} {{this.number}}</b></p>

                        {{/each}}

                        <p>Address: <b>{{qa}}</b></p>



                </div>
            </div>
        </div>


    </div>

</script>




<!-- ================================ -->
<!-- END TEMPLATES FOR CREDENTIALS    -->
<!-- ================================ -->



<!-- ================================ -->
<!-- APPLICATION SCRIPT               -->
<!-- ================================ -->

<script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>

<script src="js/jquery-3.5.1.min.js"></script>

<script src="js/localforage.min.js"></script>

<script src="js/app.js"></script>

<!-- Javascript for scanning a QR -->
<script src="js/jsQR.js"></script>

<!-- Javascript for creating a QR -->
<script src="js/easy.qrcode.min.js"></script>

</body>

</html>